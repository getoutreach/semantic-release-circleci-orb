version: 2.1

orbs:
  shared: getoutreach/shared@dev:2.33.0-rc.4

job_defaults: &job_defaults
  docker:
    - image: cimg/node:20.16.0
  environment:
    - GIT_COMMIT_DESC: git log --format=oneline -n 1 $CIRCLE_SHA1
    - PATH: "/opt/yarn/yarn-v1.5.1/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"

# -------------------------
#          JOBS
# -------------------------
jobs:
  test:
    <<: *job_defaults
    steps:
      - checkout
      - restore_cache:
          key: yarn-cache-{{ arch }}-{{ checksum "package.json" }}-{{ checksum "yarn.lock" }}-{{ .Environment.CACHE_VERSION }}
      - run:
          name: Yarn Install
          command: yarn install --non-interactive --cache-folder ~/.cache/yarn
      - save_cache:
          paths:
            - ~/.cache/yarn
          key: yarn-cache-{{ arch }}-{{ checksum "package.json" }}-{{ checksum "yarn.lock" }}-{{ .Environment.CACHE_VERSION }}
      - run:
          name: Run tests
          command: yarn test

  publish:
    executor:
      name: shared/testbed-docker-aws
      docker_tag: latest
    parameters:
      flags:
        type: string
        description: "Extra flags to pass to semantic-release"
        default: ""
    environment:
      ALLOW_MISE_TO_MANAGE_TOOL_VERSIONS: "true"
    steps:
      - shared/setup_environment
      - restore_cache:
          key: yarn-cache-{{ arch }}-{{ checksum "package.json" }}-{{ checksum "yarn.lock" }}-{{ .Environment.CACHE_VERSION }}
      - run:
          name: Yarn Install
          command: yarn install --non-interactive --cache-folder ~/.cache/yarn
      - save_cache:
          paths:
            - ~/.cache/yarn
          key: yarn-cache-{{ arch }}-{{ checksum "package.json" }}-{{ checksum "yarn.lock" }}-{{ .Environment.CACHE_VERSION }}
      - run:
          name: Publish to GitHub Packages
          command: yarn semantic-release << parameters.flags >>

# -------------------------
#        WORK FLOWS
# -------------------------
workflows:
  test-publish:
    jobs:
      - test
      - publish:
          name: publish-dryrun
          flags: "--dry-run"
          requires:
            - test
          filters:
            branches:
              ignore: master
          context:
            - aws-credentials
            - docker-registry
            - ghaccesstoken
      - publish:
          requires:
            - test
          filters:
            branches:
              only: master
          context:
            - aws-credentials
            - docker-registry
            - ghaccesstoken
