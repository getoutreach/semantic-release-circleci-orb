version: 2.1

job_defaults: &job_defaults
  docker:
    - image: cimg/node:20.16.0
  environment:
    - GIT_COMMIT_DESC: git log --format=oneline -n 1 $CIRCLE_SHA1
    - PATH: "/opt/yarn/yarn-v1.5.1/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"

# -------------------------
#          JOBS
# -------------------------
jobs:
  checkout-code:
    <<: *job_defaults
    steps:
      - checkout
      - persist_to_workspace:
          root: .
          paths: .

  test:
    <<: *job_defaults
    steps:
      - attach_workspace:
          at: .
      - restore_cache:
          key: yarn-cache-{{ arch }}-{{ checksum "package.json" }}-{{ checksum "yarn.lock" }}-{{ .Environment.CACHE_VERSION }}
      - run:
          name: Yarn Install
          command: yarn install --non-interactive --cache-folder ~/.cache/yarn
      - save_cache:
          paths:
            - ~/.cache/yarn
          key: yarn-cache-{{ arch }}-{{ checksum "package.json" }}-{{ checksum "yarn.lock" }}-{{ .Environment.CACHE_VERSION }}
      - run:
          name: Run tests
          command: yarn test

  publish:
    <<: *job_defaults
    parameters:
      flags:
        type: string
        description: "Extra flags to pass to semantic-release"
        default: ""
    steps:
      - attach_workspace:
          at: .
      - restore_cache:
          key: yarn-cache-{{ arch }}-{{ checksum "package.json" }}-{{ checksum "yarn.lock" }}-{{ .Environment.CACHE_VERSION }}
      - run:
          name: Yarn Install
          command: yarn install --non-interactive --cache-folder ~/.cache/yarn
      - save_cache:
          paths:
            - ~/.cache/yarn
          key: yarn-cache-{{ arch }}-{{ checksum "package.json" }}-{{ checksum "yarn.lock" }}-{{ .Environment.CACHE_VERSION }}
      - run:
          name: Publish to GitHub Packages
          command: yarn semantic-release << parameters.flags >>

# -------------------------
#        WORK FLOWS
# -------------------------
workflows:
  test-publish:
    jobs:
      - checkout-code
      - test:
          requires:
            - checkout-code
      - publish:
          name: publish-dryrun
          flags: "--dry-run"
          requires:
            - test
          filters:
            branches:
              ignore: master
          context:
            - ghaccesstoken
      - publish:
          requires:
            - test
          filters:
            branches:
              only: master
          context:
            - ghaccesstoken